<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Portfolio CMS (Noâ€‘backend)</title>
  <meta name="description" content="In-browser admin to manage JSON content for the portfolio site." />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- JSZip for Export/Import ZIP -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    html{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .glass{backdrop-filter:saturate(180%) blur(10px)}
    .badge{ @apply text-xs px-2 py-0.5 rounded-full border } /* for readability only */
  </style>
</head>
<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/80 dark:bg-slate-950/70 glass border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto h-16 px-4 flex items-center justify-between">
      <div class="flex gap-3 items-center">
        <span class="font-extrabold">Admin Panel</span>
        <span id="envBadge" class="text-xs px-2 py-0.5 rounded-full border border-slate-300 dark:border-slate-700">Noâ€‘backend (Local)</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="themeBtn" class="text-sm px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700">ðŸŒ“</button>
        <button id="logoutBtn" class="text-sm px-3 py-1.5 rounded-lg border border-red-200 text-red-600 dark:border-red-800">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- LOGIN -->
    <section id="loginSection" class="max-w-md mx-auto">
      <div class="p-6 rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950">
        <h1 class="text-2xl font-bold">Secure Login</h1>
        <p id="loginHint" class="text-sm text-slate-500 mt-1">Create an admin password (first time) or enter your password to login.</p>
        <div class="mt-4 space-y-3">
          <label class="block text-sm">Password
            <input id="pwd" type="password" class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </label>
          <label id="confirmWrap" class="block text-sm hidden">Confirm Password
            <input id="pwd2" type="password" class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </label>
          <div class="flex gap-2">
            <button id="loginBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-500">Login</button>
            <button id="resetBtn" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700">Reset Setup</button>
          </div>
          <p id="loginMsg" class="text-sm text-red-600"></p>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section id="appSection" class="hidden">
      <!-- Actions -->
      $1$2
        <label class="flex items-center gap-2 pl-1">
          <input id="autoSaveChk" type="checkbox" class="accent-blue-600" checked>
          <span class="text-sm">Autosave (browser)</span>
        </label>
      </div>

      <div class="grid lg:grid-cols-12 gap-6">
        <!-- Sidebar -->
        <aside class="lg:col-span-3 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 h-fit sticky top-20">
          <nav class="space-y-1" id="nav"></nav>
        </aside>

        <!-- Content -->
        <section class="lg:col-span-9 space-y-6" id="content"></section>
      </div>
    </section>
  </main>

  <script>
    // ========= The list of content files we manage =========
    const FILES = {
      site: 'data/site.json',
      stats: 'data/stats.json',
      skills: 'data/skills.json',
      academic: 'data/academic.json',
      experience: 'data/experience.json',
      projects: 'data/projects.json',
      research: 'data/research.json',
      achievements: 'data/achievements.json',
      publications: 'data/publications.json'
    };

    // ========= Global (in-memory) state =========
    const state = {
      site: { name:'', headline:'', subtitle:'', photo:'', about:'', links:{}, contact:{}, nav:[] },
      stats: { experience_years: '', projects: '', publications: '' },
      skills: { skills: [] },
      academic: [],
      experience: [],
      projects: [],
      research: [],
      achievements: [],
      publications: []
    };

    // ========= Utilities =========
    const $ = (s, root=document) => root.querySelector(s);
    const $$ = (s, root=document) => [...root.querySelectorAll(s)];
    const ok = r => { if(!r.ok) throw new Error(r.status+': '+r.url); return r; };
    const esc = (v) => String(v==null? '': v);

    function download(name, blob){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name; a.style.display='none';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
    }

    async function sha256(str){
      const enc = new TextEncoder();
      const data = enc.encode(str);
      const h = await crypto.subtle.digest('SHA-256', data);
      return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // ========= THEME =========
    (function themeInit(){
      const root = document.documentElement;
      const saved = localStorage.getItem('admin_theme');
      if (saved) root.classList.toggle('dark', saved === 'dark');
      $('#themeBtn').onclick = () => {
        const d = root.classList.toggle('dark');
        localStorage.setItem('admin_theme', d?'dark':'light');
      };
    })();

    // ========= AUTH =========
    const AUTH_KEY = 'portfolio_admin_auth';
    const DATA_KEY = 'portfolio_admin_data_v1';
    let AUTO_SAVE = (localStorage.getItem('admin_autosave') ?? 'true') === 'true';

    async function needSetup(){ return !localStorage.getItem(AUTH_KEY); }

    async function doLogin(){
      const first = await needSetup();
      const pass = $('#pwd').value.trim();
      if (!pass) { $('#loginMsg').textContent = 'Enter password'; return; }
      if (first){
        const pass2 = $('#pwd2').value.trim();
        if (pass !== pass2){ $('#loginMsg').textContent = 'Passwords do not match'; return; }
        const hash = await sha256(pass);
        localStorage.setItem(AUTH_KEY, JSON.stringify({ hash }));
        enterApp();
      } else {
        const rec = JSON.parse(localStorage.getItem(AUTH_KEY)||'{}');
        const hash = await sha256(pass);
        if (rec.hash === hash){ enterApp(); }
        else { $('#loginMsg').textContent = 'Invalid password'; }
      }
    }

    function enterApp(){
      $('#loginSection').classList.add('hidden');
      $('#appSection').classList.remove('hidden');
      buildNav();
      buildAllSections();
      // load cached data if any
      const cached = localStorage.getItem(DATA_KEY);
      if (cached){ try{ const obj = JSON.parse(cached); Object.assign(state, obj); buildAllSections(); }catch(_){} }
    }

    (async function initLogin(){
      if (await needSetup()){
        $('#confirmWrap').classList.remove('hidden');
        $('#loginHint').textContent = 'First time setup: create an admin password.';
      } else {
        $('#confirmWrap').classList.add('hidden');
        $('#loginHint').textContent = 'Enter your admin password to login.';
      }
      $('#loginBtn').onclick = doLogin;
      $('#resetBtn').onclick = () => { if (confirm('This will remove stored admin password. Continue?')){ localStorage.removeItem(AUTH_KEY); location.reload(); } };
      $('#logoutBtn').onclick = () => { location.reload(); };
    })();

    // ========= NAV =========
    const SECTIONS = [
      { id:'site', label:'Site & Settings' },
      { id:'stats_skills', label:'Stats & Skills' },
      { id:'academic', label:'Academic' },
      { id:'experience', label:'Experience' },
      { id:'projects', label:'Projects' },
      { id:'research', label:'Research' },
      { id:'achievements', label:'Achievements' },
      { id:'publications', label:'Publications' }
    ];

    function buildNav(){
      const nav = $('#nav');
      nav.innerHTML = '';
      SECTIONS.forEach(s => {
        const a = document.createElement('button');
        a.className = 'w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-900 border border-transparent';
        a.textContent = s.label;
        a.onclick = () => scrollToSection(s.id);
        nav.appendChild(a);
      });
    }

    function scrollToSection(id){
      const el = document.getElementById('sec_'+id);
      if (el) el.scrollIntoView({ behavior:'smooth', block:'start' });
    }

    // ========= GENERIC HELPERS =========
    function makeCard(title){
      const wrap = document.createElement('div');
      wrap.className = 'p-5 rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950';
      wrap.innerHTML = `<div class="flex items-center justify-between"><h2 class="text-xl font-bold">${title}</h2></div>`;
      return wrap;
    }

    function makeRow(label, inputEl){
      const row = document.createElement('div');
      row.className = 'grid md:grid-cols-3 gap-3 items-start';
      const l = document.createElement('label'); l.className = 'text-sm pt-2'; l.textContent = label;
      const r = document.createElement('div'); r.className = 'md:col-span-2'; r.appendChild(inputEl);
      row.appendChild(l); row.appendChild(r);
      return row;
    }

    function textInput(value='', placeholder=''){ const i = document.createElement('input'); i.type='text'; i.value=value||''; i.placeholder=placeholder; i.className='w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900'; return i; }
    function textArea(value='', placeholder=''){ const t=document.createElement('textarea'); t.value=value||''; t.placeholder=placeholder; t.rows=4; t.className='w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900'; return t; }
    function smallBtn(txt, cls=''){ const b=document.createElement('button'); b.textContent=txt; b.className='px-3 py-1.5 text-sm rounded-lg border border-slate-300 dark:border-slate-700 '+cls; return b; }

    function arrFromTextArea(t){ return t.value.split(/\n+/).map(s=>s.trim()).filter(Boolean); }
    function arrToText(arr){ return (arr||[]).join('\n'); }

    function moveItem(arr, idx, dir){ const ni = idx + dir; if (ni<0 || ni>=arr.length) return; const tmp = arr[idx]; arr[idx] = arr[ni]; arr[ni] = tmp; }

    // ========= SECTION BUILDERS =========
    function buildAllSections(){
      const content = $('#content');
      content.innerHTML = '';
      content.appendChild(buildSite());
      content.appendChild(buildStatsSkills());
      content.appendChild(buildCollection('academic', [
        { key:'degree', label:'Degree' },
        { key:'field', label:'Field' },
        { key:'school', label:'School' },
        { key:'year', label:'Year' },
        { key:'notes', label:'Notes', type:'textarea' }
      ]));
      content.appendChild(buildCollection('experience', [
        { key:'role', label:'Role*' },
        { key:'org', label:'Organization*' },
        { key:'start', label:'Start*' },
        { key:'end', label:'End' },
        { key:'summary', label:'Summary', type:'textarea' },
        { key:'bullets', label:'Bullets (one per line)', type:'textarea-array' }
      ]));
      content.appendChild(buildCollection('projects', [
        { key:'slug', label:'Slug*' },
        { key:'title', label:'Title*' },
        { key:'summary', label:'Summary', type:'textarea' },
        { key:'detail', label:'Detail URL' },
        { key:'images', label:'Images (one URL per line)', type:'textarea-array' }
      ]));
      content.appendChild(buildCollection('research', [
        { key:'slug', label:'Slug*' },
        { key:'title', label:'Title*' },
        { key:'summary', label:'Summary', type:'textarea' },
        { key:'detail', label:'Detail URL' },
        { key:'images', label:'Images (one URL per line)', type:'textarea-array' }
      ]));
      content.appendChild(buildCollection('achievements', [
        { key:'title', label:'Title*' },
        { key:'year', label:'Year' },
        { key:'link', label:'Link' }
      ]));
      content.appendChild(buildCollection('publications', [
        { key:'title', label:'Title*' },
        { key:'authors', label:'Authors (comma separated)' },
        { key:'year', label:'Year' },
        { key:'extra', label:'Extra', type:'textarea' },
        { key:'pdf', label:'PDF URL' }
      ]));
    }

    function buildSite(){
      const sec = document.createElement('div'); sec.id = 'sec_site';
      const card = makeCard('Site & Settings'); sec.appendChild(card);

      const form = document.createElement('div'); form.className='mt-4 space-y-4';
      const S = state.site;

      // basic
      const iName = textInput(S.name, 'Site name');
      const iHeadline = textInput(S.headline, 'Headline');
      const iSubtitle = textInput(S.subtitle, 'Subtitle');
      const iPhoto = textInput(S.photo, 'assets/profile.jpg or URL');
      const iAbout = textArea(S.about, 'About text');

      // links
      const iLinkedIn = textInput(S.links?.linkedin || '', 'https://â€¦');
      const iWebsite = textInput(S.links?.website || '', 'https://â€¦');
      const iYouTube = textInput(S.links?.youtube || '', 'https://â€¦');

      // contact
      const iEmail = textInput(S.contact?.email || '', 'name@example.com');
      const iPhone = textInput(S.contact?.phone || '', '+880â€¦');
      const iLoc = textInput(S.contact?.location || '', 'City, Country');

      // nav
      const navWrap = document.createElement('div'); navWrap.className='space-y-2';
      const navList = document.createElement('div'); navWrap.appendChild(navList);
      const btnAddNav = smallBtn('+ Add Nav'); navWrap.appendChild(btnAddNav);

      function renderNav(){
        navList.innerHTML = '';
        (S.nav||[]).forEach((n, idx) => {
          const row = document.createElement('div'); row.className='grid grid-cols-12 gap-2';
          const il = textInput(n.label||'', 'label'); il.classList.add('col-span-4');
          const ih = textInput(n.href||'', 'href or #anchor'); ih.classList.add('col-span-6');
          const tools = document.createElement('div'); tools.className='col-span-2 flex gap-1';
          const up = smallBtn('â†‘'); up.onclick=()=>{ moveItem(S.nav, idx, -1); renderNav(); };
          const dn = smallBtn('â†“'); dn.onclick=()=>{ moveItem(S.nav, idx, +1); renderNav(); };
          const del = smallBtn('âœ•','text-red-600 border-red-300 dark:border-red-700'); del.onclick=()=>{ S.nav.splice(idx,1); renderNav(); };
          tools.append(up,dn,del);
          row.append(il,ih,tools);
          navList.appendChild(row);
          il.oninput = () => n.label = il.value;
          ih.oninput = () => n.href = ih.value;
        });
      }
      btnAddNav.onclick = () => { S.nav = S.nav||[]; S.nav.push({label:'New', href:'#'}); renderNav(); };
      renderNav();

      form.append(
        makeRow('Name', iName),
        makeRow('Headline', iHeadline),
        makeRow('Subtitle', iSubtitle),
        makeRow('Profile Photo', iPhoto),
        makeRow('About', iAbout),
        makeRow('LinkedIn', iLinkedIn),
        makeRow('Website', iWebsite),
        makeRow('YouTube', iYouTube),
        makeRow('Email', iEmail),
        makeRow('Phone', iPhone),
        makeRow('Location', iLoc),
        makeRow('Navigation', navWrap)
      );

      const actions = document.createElement('div'); actions.className='mt-4 flex gap-2';
      const save = smallBtn('Save to Memory','bg-blue-600 text-white border-blue-600');
      save.onclick = () => {
        state.site = {
          name: iName.value.trim(), headline: iHeadline.value.trim(), subtitle: iSubtitle.value.trim(), photo: iPhoto.value.trim(), about: iAbout.value,
          links: { linkedin:iLinkedIn.value.trim(), website:iWebsite.value.trim(), youtube:iYouTube.value.trim() },
          contact: { email:iEmail.value.trim(), phone:iPhone.value.trim(), location:iLoc.value.trim() },
          nav: S.nav||[]
        };
        toast('Saved in memory');
      };
      actions.appendChild(save);

      card.appendChild(form); card.appendChild(actions);
      return sec;
    }

    function buildStatsSkills(){
      const sec = document.createElement('div'); sec.id='sec_stats_skills';
      const card = makeCard('Stats & Skills'); sec.appendChild(card);
      const form = document.createElement('div'); form.className='mt-4 space-y-4';

      const iExp = textInput(state.stats.experience_years, 'e.g., 5');
      const iProj = textInput(state.stats.projects, 'e.g., 30');
      const iPub = textInput(state.stats.publications, 'e.g., 3');

      const iSkills = textArea(arrToText(state.skills.skills), 'One skill per line');

      form.append(
        makeRow('Experience (years)', iExp),
        makeRow('Projects (#)', iProj),
        makeRow('Publications (#)', iPub),
        makeRow('Skills (list)', iSkills)
      );

      const actions = document.createElement('div'); actions.className='mt-4 flex gap-2';
      const save = smallBtn('Save to Memory','bg-blue-600 text-white border-blue-600');
      save.onclick = () => {
        state.stats = { experience_years: iExp.value.trim(), projects: iProj.value.trim(), publications: iPub.value.trim() };
        state.skills = { skills: arrFromTextArea(iSkills) };
        toast('Saved in memory');
      };
      actions.appendChild(save); card.appendChild(form); card.appendChild(actions);
      return sec;
    }

    function buildCollection(key, fields){
      const sec = document.createElement('div'); sec.id = 'sec_'+key;
      const titleMap = { academic:'Academic', experience:'Experience', projects:'Projects', research:'Research', achievements:'Achievements', publications:'Publications' };
      const card = makeCard(titleMap[key] || key); sec.appendChild(card);

      const list = document.createElement('div'); list.className='mt-4 space-y-3';
      const actionsTop = document.createElement('div'); actionsTop.className='mb-2 flex gap-2';
      const addBtn = smallBtn('+ Add');
      const saveBtn = smallBtn('Save to Memory','bg-blue-600 text-white border-blue-600');
      const saveDlBtn = smallBtn('Save & Download JSON','bg-green-600 text-white border-green-600');
      actionsTop.append(addBtn, saveBtn, saveDlBtn);

      function render(){
        list.innerHTML = '';
        (state[key]||[]).forEach((item, idx) => {
          const row = document.createElement('div');
          row.className = 'p-4 rounded-xl border border-slate-200 dark:border-slate-800';

          const grid = document.createElement('div'); grid.className = 'grid md:grid-cols-2 gap-3';
          const inputs = {};

          fields.forEach(f => {
            let inputEl;
            if (f.type === 'textarea') inputEl = textArea(item[f.key]||'');
            else if (f.type === 'textarea-array') inputEl = textArea(arrToText(item[f.key]||[]));
            else inputEl = textInput(item[f.key]||'');
            inputs[f.key] = inputEl;
            const label = document.createElement('label'); label.className='text-sm'; label.textContent = f.label;
            const wrap = document.createElement('div');
            wrap.appendChild(label); wrap.appendChild(inputEl);
            grid.appendChild(wrap);
          });

          const tools = document.createElement('div'); tools.className='mt-2 flex gap-2';
          const up = smallBtn('â†‘'); up.onclick = () => { moveItem(state[key], idx, -1); render(); if (AUTO_SAVE) saveLocal(); };
          const dn = smallBtn('â†“'); dn.onclick = () => { moveItem(state[key], idx, +1); render(); if (AUTO_SAVE) saveLocal(); };
          const del = smallBtn('Delete','text-red-600 border-red-300 dark:border-red-700'); del.onclick = () => { state[key].splice(idx,1); render(); if (AUTO_SAVE) saveLocal(); };

          tools.append(up,dn,del);
          row.appendChild(grid); row.appendChild(tools);
          list.appendChild(row);

          // bind changes back on save
          row._collect = () => {
            const obj = {};
            fields.forEach(f => {
              if (f.type === 'textarea-array') obj[f.key] = arrFromTextArea(inputs[f.key]);
              else obj[f.key] = inputs[f.key].value;
            });
            return obj;
          };
        });
      }

      addBtn.onclick = () => { (state[key] = state[key]||[]).push({}); render(); if (AUTO_SAVE) saveLocal(); };
      saveBtn.onclick = () => {
        // collect back
        const rows = [...list.children];
        state[key] = rows.map(r => r._collect());
        saveLocal();
        toast('Saved in memory');
      };
      saveDlBtn.onclick = () => {
        const rows = [...list.children];
        state[key] = rows.map(r => r._collect());
        saveLocal();
        let payload = state[key];
        if (key==='publications') {
          payload = (state[key]||[]).map(p=> ({...p, authors: (Array.isArray(p.authors)? p.authors : (p.authors||'').split(',').map(s=>s.trim()).filter(Boolean))}));
        }
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        download(key+'.json', blob);
        toast('Saved & downloaded '+key+'.json');
      };

      render();

      card.appendChild(actionsTop);
      card.appendChild(list);

      // footer with quick export of this collection only
      const foot = document.createElement('div'); foot.className='mt-3 flex gap-2';
      const exp = smallBtn('Export '+(titleMap[key]||key)+'.json');
      exp.onclick = () => {
        let payload = state[key];
        // publications.authors is comma separated string in UI; keep as array if provided as array already elsewhere
        if (key==='publications') {
          payload = (state[key]||[]).map(p=> ({...p, authors: (Array.isArray(p.authors)? p.authors : (p.authors||'').split(',').map(s=>s.trim()).filter(Boolean))}));
        }
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        download(key+'.json', blob);
      };
      foot.appendChild(exp);
      card.appendChild(foot);

      return sec;
    }

    // ========= TOAST =========
    function toast(msg){
      let t = document.getElementById('toast');
      if (!t){ t = document.createElement('div'); t.id='toast'; t.className='fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl bg-black/80 text-white text-sm'; document.body.appendChild(t); }
      t.textContent = msg; t.style.opacity='1';
      clearTimeout(t._timer); t._timer = setTimeout(()=> t.style.opacity='0', 1600);
    }

    // ========= LOAD / SAVE / IMPORT / EXPORT =========
    async function loadFromServer(){
      for (const [k, path] of Object.entries(FILES)){
        try{
          const r = await fetch(path, {cache:'no-store'}).then(ok).then(r=>r.json());
          state[k] = r;
        }catch(e){ console.warn('Skip load', k, e.toString()); }
      }
      localStorage.setItem(DATA_KEY, JSON.stringify(state));
      buildAllSections();
      toast('Loaded from /data');
    }

    function saveLocal(){
      localStorage.setItem(DATA_KEY, JSON.stringify(state));
      toast('Saved to browser (localStorage)');
    }

    async function exportZip(){
      const zip = new JSZip();
      const folder = zip.folder('data');
      const site = {...state.site};
      // ensure publications.authors array
      const pubs = (state.publications||[]).map(p=> ({...p, authors: (Array.isArray(p.authors)? p.authors : (p.authors||'').split(',').map(s=>s.trim()).filter(Boolean))}));

      folder.file('site.json', JSON.stringify(site, null, 2));
      folder.file('stats.json', JSON.stringify(state.stats, null, 2));
      folder.file('skills.json', JSON.stringify(state.skills, null, 2));
      folder.file('academic.json', JSON.stringify(state.academic, null, 2));
      folder.file('experience.json', JSON.stringify(state.experience, null, 2));
      folder.file('projects.json', JSON.stringify(state.projects, null, 2));
      folder.file('research.json', JSON.stringify(state.research, null, 2));
      folder.file('achievements.json', JSON.stringify(state.achievements, null, 2));
      folder.file('publications.json', JSON.stringify(pubs, null, 2));

      const blob = await zip.generateAsync({type:'blob'});
      download('data.zip', blob);
    }

    async function importFiles(files){
      const zips = [...files].filter(f=>/\.zip$/i.test(f.name));
      const jsons = [...files].filter(f=>/\.json$/i.test(f.name));

      if (zips.length){
        for (const f of zips){
          const ab = await f.arrayBuffer();
          const zip = await JSZip.loadAsync(ab);
          const entries = Object.values(zip.files);
          for (const entry of entries){
            if (entry.dir) continue;
            if (!/\.json$/i.test(entry.name)) continue;
            const text = await entry.async('string');
            applyJsonByName(entry.name, text);
          }
        }
      }

      for (const f of jsons){
        const text = await f.text();
        applyJsonByName(f.name, text);
      }

      localStorage.setItem(DATA_KEY, JSON.stringify(state));
      buildAllSections();
      toast('Imported data');
    }

    function applyJsonByName(name, text){
      try{
        const obj = JSON.parse(text);
        const lower = name.toLowerCase();
        // accept both `data/*.json` and bare `*.json`
        const key = lower.replace(/^.*\//,'').replace(/\.json$/,'');
        if (key in state){ state[key] = obj; }
        else if (key === 'stats') state.stats = obj;
        else if (key === 'skills') state.skills = obj;
      }catch(e){ console.warn('Invalid JSON', name, e); }
    }

    // Wire buttons
    $('#loadServerBtn').onclick = loadFromServer;
    $('#saveLocalBtn').onclick = saveLocal;
    $('#exportZipBtn').onclick = exportZip;
    $('#importInput').addEventListener('change', (e)=> importFiles(e.target.files));
    const autoChk = document.getElementById('autoSaveChk');
    if (autoChk){ autoChk.checked = AUTO_SAVE; autoChk.onchange = () => { AUTO_SAVE = autoChk.checked; localStorage.setItem('admin_autosave', String(AUTO_SAVE)); if (AUTO_SAVE) saveLocal(); }; }

  </script>
</body>
</html>
